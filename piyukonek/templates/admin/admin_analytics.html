<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary-color:#4CAF50; --primary-dark:#45a049; --secondary-color:#f8fafc; --text-primary:#1e293b; --text-secondary:#64748b; --border-color:#e2e8f0; --shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1); --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1);} 
    * { box-sizing:border-box; font-family:'Poppins',sans-serif; margin:0; padding:0; }
    body { display:flex; min-height:100vh; background:var(--secondary-color);} 
    .sidebar { width:280px; background:white; padding:25px; position:fixed; height:100vh; border-right:1px solid var(--border-color); box-shadow:var(--shadow-md);} 
    .sidebar-header { display:flex; align-items:center; padding:20px 0; border-bottom:1px solid var(--border-color); margin-bottom:30px; }
    .sidebar-header img { width:90px; height:90px; margin-right:15px; border-radius:12px; box-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);} 
    .nav-menu { margin-top:20px; }
    .nav-item { margin-bottom:8px; }
    .nav-link { display:flex; align-items:center; padding:14px 20px; color:var(--text-secondary); text-decoration:none; border-radius:12px; transition:all 0.3s ease; font-weight:500; }
    .nav-link:hover { background:var(--secondary-color); color:var(--primary-color);} 
    .nav-link.active { background:var(--primary-color); color:white; }
    .nav-link i { margin-right:12px; font-size:1.1rem; width:20px; text-align:center; }
    .main-content { flex:1; margin-left:280px; padding:30px; overflow-y:auto; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:20px 0; border-bottom:1px solid var(--border-color);} 
    .export-btn { background:var(--primary-color); color:white; padding:12px 24px; border:none; border-radius:8px; font-weight:500; cursor:pointer; transition: all 0.3s ease; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .export-btn:hover { background:var(--primary-dark); transform:translateY(-2px);} 
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px; }
    .stat-card { background:white; padding:25px; border-radius:12px; box-shadow:var(--shadow-md); border:1px solid var(--border-color);} 
    .stat-icon { width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:white; }
    .stat-icon.primary { background:#4CAF50; } .stat-icon.success { background:#22c55e; } .stat-icon.warning { background:#f59e0b; } .stat-icon.info { background:#3b82f6; }
    .stat-value { font-size:2rem; font-weight:600; color:var(--text-primary); margin-bottom:5px; }
    .stat-label { color:var(--text-secondary); font-size:0.9rem; font-weight:500; }
    .charts-section { display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:30px; }
    .chart-card { background:white; padding:25px; border-radius:12px; box-shadow:var(--shadow-md); border:1px solid var(--border-color);} 
    .chart-title { font-size:1.2rem; font-weight:600; color:var(--text-primary); margin-bottom:20px; }
    .chart-container { position:relative; height:300px; }
    .recent-concerns { background:white; padding:25px; border-radius:12px; box-shadow:var(--shadow-md); border:1px solid var(--border-color);} 
    .recent-header { font-size:1.2rem; font-weight:600; color:var(--text-primary); margin-bottom:20px; }
    .concern-item { display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid var(--border-color);} 
    .concern-item:last-child { border-bottom:none; }
    .concern-title { font-weight:600; color:var(--text-primary); text-transform:capitalize; }
    .concern-meta { color:var(--text-secondary); font-size:0.9rem; text-transform:capitalize; }
    .concern-status { padding:6px 12px; border-radius:20px; background:#f1f5f9; text-transform:capitalize; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="LSPU Logo">
      <h2>PiyuKonek</h2>
    </div>
    <nav class="nav-menu">
      <div class="nav-item">
        <a href="{{ url_for('admin_dashboard') }}" class="nav-link{% if request.endpoint == 'admin_dashboard' %} active{% endif %}"><i class="fas fa-home"></i><span>Dashboard</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('user_management') }}" class="nav-link{% if request.endpoint == 'user_management' %} active{% endif %}"><i class="fas fa-users"></i><span>User Management</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_user_approval') }}" class="nav-link{% if request.endpoint == 'admin_user_approval' %} active{% endif %}"><i class="fas fa-user-check"></i><span>User Approval</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_concern') }}" class="nav-link{% if request.endpoint == 'admin_concern' %} active{% endif %}"><i class="fas fa-exclamation-circle"></i><span>Concerns</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_departments') }}" class="nav-link{% if request.endpoint == 'admin_departments' %} active{% endif %}"><i class="fas fa-building"></i><span>Departments</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_courses') }}" class="nav-link{% if request.endpoint == 'admin_courses' %} active{% endif %}"><i class="fas fa-book"></i><span>Courses</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_notification') }}" class="nav-link{% if request.endpoint == 'admin_notification' %} active{% endif %}"><i class="fas fa-bell"></i><span>Notifications</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_activities') }}" class="nav-link{% if request.endpoint == 'admin_activities' %} active{% endif %}"><i class="fas fa-list"></i><span>Activities</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_concern_types') }}" class="nav-link{% if request.endpoint == 'admin_concern_types' %} active{% endif %}"><i class="fas fa-tags"></i><span>Concern Types</span></a>
      </div>
      <div class="nav-item">
        <a href="{{ url_for('admin_analytics') }}" class="nav-link active"><i class="fas fa-chart-line"></i><span>Analytics</span></a>
      </div>
      <div class="nav-item"><a href="#" class="nav-link" onclick="confirmLogout(event)"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></div>
    </nav>
  </div>
  <div class="main-content">
    <div class="top-bar">
      <h2>Admin Analytics Dashboard</h2>
      <a href="{{ url_for('admin_export_analytics') }}" class="export-btn"><i class="fas fa-file-pdf"></i> Export PDF</a>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-exclamation-circle"></i></div><div class="stat-value">{{ total_concerns }}</div><div class="stat-label">Total Concerns</div></div>
      <div class="stat-card"><div class="stat-icon success"><i class="fas fa-check-circle"></i></div><div class="stat-value">{{ resolved_concerns }}</div><div class="stat-label">Resolved</div></div>
      <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-spinner"></i></div><div class="stat-value">{{ processing_concerns }}</div><div class="stat-label">Processing</div></div>
      <div class="stat-card"><div class="stat-icon info"><i class="fas fa-hourglass-half"></i></div><div class="stat-value">{{ pending_concerns }}</div><div class="stat-label">Pending</div></div>
      <div class="stat-card"><div class="stat-icon info"><i class="fas fa-percentage"></i></div><div class="stat-value">{{ "%.1f"|format(resolution_rate) }}%</div><div class="stat-label">Resolution Rate</div></div>
    </div>
    <div class="charts-section">
      <div class="chart-card"><div class="chart-title">Monthly Performance Trend</div><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
      <div class="chart-card">
        <div class="chart-title">Performance Metrics</div>
        <div style="display:grid;gap:10px;">
          <div>Avg Response Time: <b>{{ "%.1f"|format(avg_response_time) }}</b> hours</div>
          <div>Avg Resolution Time: <b>{{ "%.1f"|format(avg_resolution_time) }}</b> hours</div>
        </div>
      </div>
    </div>
    <div class="charts-section">
      <div class="chart-card"><div class="chart-title">Concerns by Priority</div><div class="chart-container"><canvas id="priorityChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Concerns by Type</div><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
    </div>
    <div class="recent-concerns">
      <h4 class="recent-header">Recent Concerns</h4>
      {% for c in recent_concerns %}
        <div class="concern-item">
          <div>
            <div class="concern-title">{{ c.title }}</div>
            <div class="concern-meta">{{ c.concern_type }} â€¢ {{ c.priority_level }}</div>
          </div>
          <div class="concern-status">{{ c.status }}</div>
        </div>
      {% else %}
        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent concerns found.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    // Function to capitalize first letter of each word
    function capitalizeWords(text) {
      if (!text) return '';
      return text.toString().replace(/\b\w/g, function(char) {
        return char.toUpperCase();
      });
    }

    const monthlyData = {{ monthly_data | tojson if monthly_data else [] }};
    const priorityStats = {{ priority_stats | tojson if priority_stats else {} }};
    const typeStats = {{ type_stats | tojson if type_stats else {} }};

    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, { type:'line', data:{ labels: monthlyData.map(i=>i.month||'Unknown'), datasets:[{ label:'Total', data: monthlyData.map(i=>i.total||0), borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,0.1)', tension:0.4, fill:true }, { label:'Resolved', data: monthlyData.map(i=>i.resolved||0), borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.1)', tension:0.4, fill:true }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 }}}}});

    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, { type:'doughnut', data:{ labels:Object.keys(priorityStats).map(capitalizeWords), datasets:[{ data:Object.values(priorityStats).map(s => s && typeof s==='object' ? (s.total||0) : (s||0)), backgroundColor:['#4CAF50','#FF9800','#F44336','#9C27B0'], borderWidth:2, borderColor:'#fff' }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' }}}});

    const typeCtx = document.getElementById('typeChart').getContext('2d');
    new Chart(typeCtx, { type:'doughnut', data:{ labels:Object.keys(typeStats).map(capitalizeWords), datasets:[{ data:Object.values(typeStats).map(s => s && typeof s==='object' ? (s.total||0) : (s||0)), backgroundColor:['#2196F3','#FF5722','#795548','#607D8B','#E91E63'], borderWidth:2, borderColor:'#fff' }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' }}}});

    function confirmLogout(event){ event.preventDefault(); if(confirm('Are you sure you want to logout?')) { window.location.href = "{{ url_for('logout', tab=current_tab) }}"; } }
  </script>
</body>
</html>


